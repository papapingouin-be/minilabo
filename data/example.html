<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <title>Exemple : mesure de puissance</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 1em; }
    h1 { margin-top: 0; }
    .controls { margin-bottom: 1em; }
    label { margin-right: 0.5em; }
    select, input { margin-right: 1em; }
    canvas { max-width: 100%; height: 300px; }
  </style>
  <!-- Chart.js from CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
</head>
<body>
<h1>Exemple de mesure de puissance</h1>
<p>Cette page calcule la puissance électrique P à partir d’une entrée locale (courant) et d’une entrée distante (tension). Configurez vos entrées dans le système pour attribuer un type <em>Div</em> ou <em>ZMCT</em> pour le courant et <em>Remote</em> pour la tension.</p>

<div class="controls">
  <label for="currentInput">Entrée locale (courant)&nbsp;:</label>
  <select id="currentInput"></select>
  <label for="voltageInput">Entrée distante (tension)&nbsp;:</label>
  <select id="voltageInput"></select>
  <button id="startBtn">Démarrer</button>
  <button id="stopBtn" disabled>Arrêter</button>
</div>

<p>Courant (A)&nbsp;: <span id="iVal">–</span> | Tension (V)&nbsp;: <span id="uVal">–</span> | Puissance (W)&nbsp;: <strong><span id="pVal">–</span></strong></p>

<canvas id="chart"></canvas>

<script>
let running = false;
let timerId = null;
let chart = null;
const maxPoints = 60;

// Load inputs and remote info for dropdowns
async function initInputs() {
  const cfg = await (await fetch('/api/config/get')).json();
  const currentSel = document.getElementById('currentInput');
  const voltageSel = document.getElementById('voltageInput');
  currentSel.innerHTML = '';
  voltageSel.innerHTML = '';
  // Populate with local inputs
  cfg.inputs.forEach(ic => {
    if (ic.active && (ic.type === 'div' || ic.type === 'zmct')) {
      const opt = document.createElement('option');
      opt.value = ic.name;
      opt.textContent = ic.name + ' (' + ic.type + ')';
      currentSel.appendChild(opt);
    }
  });
  // Populate with remote inputs (type remote)
  cfg.inputs.forEach(ic => {
    if (ic.active && ic.type === 'remote') {
      const opt = document.createElement('option');
      opt.value = ic.name;
      opt.textContent = ic.name + ' (remote)';
      voltageSel.appendChild(opt);
    }
  });
}

// Initialise chart
function initChart() {
  const ctx = document.getElementById('chart').getContext('2d');
  chart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: [],
      datasets: [{
        label: 'Puissance (W)',
        data: [],
        fill: false,
        borderColor: 'rgba(75, 192, 192, 1)',
        tension: 0.1
      }]
    },
    options: {
      responsive: true,
      scales: {
        x: { title: { display: true, text: 'Temps (s)' } },
        y: { title: { display: true, text: 'Puissance (W)' } }
      }
    }
  });
}

async function fetchValues(curName, voltName) {
  try {
    const inResp = await fetch('/api/inputs');
    const inputs = await inResp.json();
    const i = inputs[curName];
    const u = inputs[voltName];
    return { i: i, u: u };
  } catch (err) {
    console.error(err);
    return { i: NaN, u: NaN };
  }
}

function updateDisplay(i, u, t) {
  const p = (isFinite(i) && isFinite(u)) ? i * u : NaN;
  document.getElementById('iVal').textContent = isFinite(i) ? i.toFixed(3) : '–';
  document.getElementById('uVal').textContent = isFinite(u) ? u.toFixed(3) : '–';
  document.getElementById('pVal').textContent = isFinite(p) ? p.toFixed(3) : '–';
  // Update chart
  if (chart) {
    const data = chart.data;
    const labels = data.labels;
    const dataset = data.datasets[0].data;
    if (labels.length >= maxPoints) {
      labels.shift();
      dataset.shift();
    }
    labels.push(t.toFixed(1));
    dataset.push(isFinite(p) ? p : null);
    chart.update('none');
  }
}

function start() {
  if (running) return;
  const curName = document.getElementById('currentInput').value;
  const voltName = document.getElementById('voltageInput').value;
  if (!curName || !voltName) {
    alert('Veuillez sélectionner des entrées valides');
    return;
  }
  running = true;
  document.getElementById('startBtn').disabled = true;
  document.getElementById('stopBtn').disabled = false;
  let t0 = Date.now();
  timerId = setInterval(async () => {
    const now = Date.now();
    const t = (now - t0) / 1000.0;
    const vals = await fetchValues(curName, voltName);
    updateDisplay(vals.i, vals.u, t);
  }, 1000);
}

function stop() {
  if (!running) return;
  clearInterval(timerId);
  running = false;
  document.getElementById('startBtn').disabled = false;
  document.getElementById('stopBtn').disabled = true;
}

window.addEventListener('DOMContentLoaded', () => {
  initInputs();
  initChart();
  document.getElementById('startBtn').addEventListener('click', start);
  document.getElementById('stopBtn').addEventListener('click', stop);
});
</script>

</body>
</html>