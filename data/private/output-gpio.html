<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <title>Exemple – Sortie GPIO</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 1em; max-width: 720px; }
    h1 { margin-top: 0; }
    .controls { display: flex; gap: 0.5em; align-items: center; flex-wrap: wrap; margin-bottom: 1em; }
    select { padding: 0.3em; }
    .panel { border: 1px solid #d0d7e2; border-radius: 8px; padding: 1em; background: #fdfefe; margin-bottom: 1em; }
    .panel h2 { margin-top: 0; font-size: 1.05em; }
    .hint { font-size: 0.95em; color: #34495e; }
    .status { font-size: 0.9em; min-height: 1.2em; }
    .status.ok { color: #2c3e50; }
    .status:not(.ok) { color: #c0392b; }
    .badge { display: inline-flex; align-items: center; gap: 0.3em; font-size: 0.85em; padding: 0.2em 0.5em; border-radius: 999px; background: #ecf0f6; color: #34495e; }
    .badge.active { background: #e8f8f0; color: #2f7a40; }
    .toggle { display: flex; align-items: center; gap: 0.6em; font-size: 1.1em; }
    .toggle input { width: 48px; height: 24px; }
    .metrics { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 0.75em; }
    .metric { background: #f3f7ff; border-radius: 6px; padding: 0.75em; }
    .metric span { display: block; font-size: 0.85em; color: #4b5874; }
    .metric strong { font-size: 1.4em; }
  </style>
  <script src="../auth.js"></script>
  <script src="io-exemples-utils.js"></script>
</head>
<body>
<h1>Exemple – Sortie GPIO numérique</h1>
<p class="hint">Utilisez cette page pour tester une sortie configurée en <strong>GPIO</strong>. Les consignes 0/1 sont converties en niveaux logiques 0 V / 3,3 V sur la broche choisie.</p>

<div class="controls">
  <label for="outputSelect">Sortie GPIO&nbsp;:</label>
  <select id="outputSelect"></select>
  <span class="status" id="status"></span>
</div>

<div class="panel">
  <h2>Détails de la sortie</h2>
  <p class="hint">Tag JSON&nbsp;: <code id="tagName">—</code></p>
  <p class="hint">Échelle / Décalage&nbsp;: <span id="scaleInfo">—</span> (le seuil 0,5 déclenche l’état HIGH)</p>
  <p class="hint">État&nbsp;: <span class="badge" id="activeBadge">—</span></p>
</div>

<div class="panel">
  <h2>Envoyer un niveau logique</h2>
  <div class="toggle">
    <label for="toggle">Niveau de sortie&nbsp;:</label>
    <input type="checkbox" id="toggle">
    <span id="toggleLabel">LOW</span>
  </div>
  <p class="hint">Décochez pour forcer LOW (0) et cochez pour forcer HIGH (1). L’envoi est immédiat.</p>
</div>

<div class="panel">
  <h2>État observé</h2>
  <div class="metrics">
    <div class="metric">
      <span>Consigne actuelle</span>
      <strong id="currentValue">—</strong>
      <span>Valeur reçue via l’API</span>
    </div>
    <div class="metric">
      <span>Niveau logique</span>
      <strong id="logicLevel">—</strong>
      <span>0 V ≈ LOW, 3,3 V ≈ HIGH</span>
    </div>
  </div>
</div>

<script>
(function() {
  'use strict';

  const state = {
    entries: [],
    selected: null,
    timer: null,
    values: {},
    suppressUpdate: false
  };

  const selectEl = document.getElementById('outputSelect');
  const statusEl = document.getElementById('status');
  const tagEl = document.getElementById('tagName');
  const scaleEl = document.getElementById('scaleInfo');
  const activeBadge = document.getElementById('activeBadge');
  const toggleEl = document.getElementById('toggle');
  const toggleLabel = document.getElementById('toggleLabel');
  const currentValueEl = document.getElementById('currentValue');
  const logicLevelEl = document.getElementById('logicLevel');

  function showStatus(message, isError = false) {
    statusEl.textContent = message || '';
    if (!message) {
      statusEl.classList.remove('ok');
      return;
    }
    if (isError) {
      statusEl.classList.remove('ok');
    } else {
      statusEl.classList.add('ok');
    }
  }

  function stopTimer() {
    if (state.timer) {
      clearInterval(state.timer);
      state.timer = null;
    }
  }

  function updateInfo(entry) {
    if (!entry) {
      tagEl.textContent = '—';
      scaleEl.textContent = '—';
      activeBadge.textContent = '—';
      activeBadge.classList.remove('active');
      toggleEl.disabled = true;
      toggleEl.checked = false;
      toggleLabel.textContent = 'LOW';
      return;
    }
    tagEl.textContent = entry.name;
    const gain = ExampleUtils.normaliseNumber(entry.scale);
    const offset = ExampleUtils.normaliseNumber(entry.offset) ?? 0;
    scaleEl.textContent = `${gain ?? '—'} / ${offset}`;
    toggleEl.disabled = false;
  }

  function applyActiveBadge(data) {
    if (!data) {
      activeBadge.textContent = '—';
      activeBadge.classList.remove('active');
      return;
    }
    if (data.active) {
      activeBadge.textContent = 'Sortie active';
      activeBadge.classList.add('active');
    } else {
      activeBadge.textContent = 'Sortie désactivée';
      activeBadge.classList.remove('active');
    }
  }

  function updateToggleDisplay(value) {
    const num = ExampleUtils.normaliseNumber(value);
    if (num === null) {
      toggleLabel.textContent = '—';
      return;
    }
    const isHigh = num >= 0.5;
    toggleEl.checked = isHigh;
    toggleLabel.textContent = isHigh ? 'HIGH' : 'LOW';
  }

  function updateDisplay() {
    if (!state.selected) {
      currentValueEl.textContent = '—';
      logicLevelEl.textContent = '—';
      applyActiveBadge(null);
      return;
    }
    const measurement = state.values[state.selected];
    const current = measurement ? measurement.value : null;
    currentValueEl.textContent = ExampleUtils.formatNumber(current, 2);
    logicLevelEl.textContent = current === null ? '—' : (current >= 0.5 ? 'HIGH' : 'LOW');
    applyActiveBadge(measurement);
    if (!state.suppressUpdate) {
      updateToggleDisplay(current);
    }
  }

  async function refreshValues() {
    try {
      const map = await ExampleUtils.fetchOutputsValues();
      state.values = map;
      updateDisplay();
      showStatus('');
    } catch (err) {
      showStatus(err.message || 'Erreur de lecture', true);
    }
  }

  function handleSelectChange() {
    state.selected = selectEl.value || null;
    const entry = state.entries.find(e => e.name === state.selected);
    updateInfo(entry);
    updateDisplay();
  }

  async function applyToggleChange() {
    if (!state.selected) {
      showStatus('Sélectionnez une sortie GPIO.', true);
      return;
    }
    const value = toggleEl.checked ? 1 : 0;
    state.suppressUpdate = true;
    try {
      showStatus('Envoi en cours…');
      await ExampleUtils.sendOutputValue(state.selected, value);
      showStatus('Consigne appliquée.');
      toggleLabel.textContent = value ? 'HIGH' : 'LOW';
      await refreshValues();
    } catch (err) {
      showStatus(err.message || 'Échec de l’envoi.', true);
      toggleEl.checked = !toggleEl.checked;
      toggleLabel.textContent = toggleEl.checked ? 'HIGH' : 'LOW';
    } finally {
      setTimeout(() => {
        state.suppressUpdate = false;
      }, 500);
    }
  }

  async function init() {
    const cfg = await ExampleUtils.loadConfig();
    state.entries = ExampleUtils.outputsByType(cfg, 'gpio');
    selectEl.innerHTML = '';
    if (!state.entries.length) {
      const opt = document.createElement('option');
      opt.textContent = 'Aucune sortie GPIO active';
      opt.value = '';
      selectEl.appendChild(opt);
      selectEl.disabled = true;
      toggleEl.disabled = true;
      showStatus('Activez une sortie GPIO dans la configuration.', true);
      updateInfo(null);
      return;
    }
    state.entries.forEach(entry => {
      const opt = document.createElement('option');
      opt.value = entry.name;
      opt.textContent = entry.name;
      selectEl.appendChild(opt);
    });
    selectEl.disabled = false;
    state.selected = state.entries[0].name;
    selectEl.value = state.selected;
    updateInfo(state.entries[0]);
    await refreshValues();
    stopTimer();
    state.timer = setInterval(refreshValues, 1000);
  }

  selectEl.addEventListener('change', handleSelectChange);
  toggleEl.addEventListener('change', applyToggleChange);
  window.addEventListener('beforeunload', stopTimer);

  ensureSession()
    .then(init)
    .catch(err => {
      showStatus(err.message || 'Authentification requise', true);
    });
})();
</script>
</body>
</html>
