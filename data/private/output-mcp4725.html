<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <title>Exemple – Sortie DAC MCP4725</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 1em; max-width: 780px; }
    h1 { margin-top: 0; }
    .controls { display: flex; gap: 0.5em; align-items: center; flex-wrap: wrap; margin-bottom: 1em; }
    select { padding: 0.3em; }
    .panel { border: 1px solid #d0d7e2; border-radius: 8px; padding: 1em; background: #fdfefe; margin-bottom: 1em; }
    .panel h2 { margin-top: 0; font-size: 1.05em; }
    .metrics { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 0.75em; }
    .metric { background: #f3f7ff; border-radius: 6px; padding: 0.75em; }
    .metric span { display: block; font-size: 0.85em; color: #4b5874; }
    .metric strong { font-size: 1.4em; }
    code { background: #eef2f8; padding: 0.2em 0.4em; border-radius: 4px; }
    .hint { font-size: 0.95em; color: #34495e; }
    .status { font-size: 0.9em; min-height: 1.2em; }
    .status.ok { color: #2c3e50; }
    .status:not(.ok) { color: #c0392b; }
    .badge { display: inline-flex; align-items: center; gap: 0.3em; font-size: 0.85em; padding: 0.2em 0.5em; border-radius: 999px; background: #ecf0f6; color: #34495e; }
    .badge.active { background: #e8f8f0; color: #2f7a40; }
    .range-control { display: flex; align-items: center; gap: 0.75em; flex-wrap: wrap; }
    .range-control input[type="range"] { flex: 1 1 240px; }
    .range-control input[type="number"] { width: 110px; }
    .actions { display: flex; gap: 0.5em; }
    button { padding: 0.4em 0.9em; font-size: 1em; }
  </style>
  <script src="../auth.js"></script>
  <script src="io-exemples-utils.js"></script>
</head>
<body>
<h1>Exemple – DAC I²C MCP4725</h1>
<p class="hint">Pilotez ici une sortie <strong>MCP4725</strong>. Le DAC fournit une tension analogique 12 bits (0–4095 codes) proportionnelle à l’unité configurée (souvent des volts).</p>

<div class="controls">
  <label for="outputSelect">Sortie DAC&nbsp;:</label>
  <select id="outputSelect"></select>
  <span class="status" id="status"></span>
</div>

<div class="panel">
  <h2>Détails de la sortie</h2>
  <p class="hint">Tag JSON&nbsp;: <code id="tagName">—</code></p>
  <p class="hint">Échelle / Décalage&nbsp;: <span id="scaleInfo">—</span></p>
  <p class="hint">Adresse I²C&nbsp;: <code id="i2cInfo">—</code></p>
  <p class="hint">Plage estimée (d’après l’échelle)&nbsp;: <span id="rangeInfo">—</span></p>
  <p class="hint">État&nbsp;: <span class="badge" id="activeBadge">—</span></p>
</div>

<div class="panel">
  <h2>Envoyer une consigne</h2>
  <div class="range-control">
    <label for="valueRange">Consigne (typ. 0–5 V)&nbsp;:</label>
    <input type="range" id="valueRange" min="0" max="5" step="0.05" value="0">
    <input type="number" id="valueInput" step="0.01" value="0">
    <div class="actions">
      <button id="sendBtn" type="button">Appliquer</button>
      <button id="zeroBtn" type="button">Mettre à 0</button>
      <button id="fullScaleBtn" type="button">Plein échelle</button>
    </div>
  </div>
</div>

<div class="panel">
  <h2>Consigne appliquée</h2>
  <div class="metrics">
    <div class="metric">
      <span>Valeur envoyée</span>
      <strong id="currentValue">—</strong>
      <span id="unitHint">Unité définie dans la configuration</span>
    </div>
    <div class="metric">
      <span>Code DAC (0–4095)</span>
      <strong id="rawCode">—</strong>
      <span>Résolution 12 bits</span>
    </div>
  </div>
</div>

<p class="hint">Astuce : avec une alimentation 5 V et une sortie en volts, l’échelle typique est de <code>819</code> (4095 codes / 5 V). Utilisez le bouton « Plein échelle » pour atteindre rapidement la tension maximale.</p>

<script>
(function() {
  'use strict';

  const state = {
    entries: [],
    selected: null,
    timer: null,
    values: {},
    editing: false,
    editTimeout: null
  };

  const selectEl = document.getElementById('outputSelect');
  const statusEl = document.getElementById('status');
  const tagEl = document.getElementById('tagName');
  const scaleEl = document.getElementById('scaleInfo');
  const rangeInfoEl = document.getElementById('rangeInfo');
  const i2cInfoEl = document.getElementById('i2cInfo');
  const activeBadge = document.getElementById('activeBadge');
  const rangeEl = document.getElementById('valueRange');
  const inputEl = document.getElementById('valueInput');
  const sendBtn = document.getElementById('sendBtn');
  const zeroBtn = document.getElementById('zeroBtn');
  const fullScaleBtn = document.getElementById('fullScaleBtn');
  const currentValueEl = document.getElementById('currentValue');
  const rawCodeEl = document.getElementById('rawCode');
  const unitHintEl = document.getElementById('unitHint');

  function showStatus(message, isError = false) {
    statusEl.textContent = message || '';
    if (!message) {
      statusEl.classList.remove('ok');
      return;
    }
    if (isError) {
      statusEl.classList.remove('ok');
    } else {
      statusEl.classList.add('ok');
    }
  }

  function stopTimer() {
    if (state.timer) {
      clearInterval(state.timer);
      state.timer = null;
    }
  }

  function clearEditingSoon() {
    if (state.editTimeout) {
      clearTimeout(state.editTimeout);
    }
    state.editTimeout = setTimeout(() => {
      state.editing = false;
    }, 1500);
  }

  function markEditing() {
    state.editing = true;
    clearEditingSoon();
  }

  function computeRangeText(scale, offset) {
    const gain = ExampleUtils.normaliseNumber(scale);
    const off = ExampleUtils.normaliseNumber(offset) ?? 0;
    if (!Number.isFinite(gain) || gain === 0) {
      return '—';
    }
    const min = (0 - off) / gain;
    const max = (4095 - off) / gain;
    if (!Number.isFinite(min) || !Number.isFinite(max)) {
      return '—';
    }
    const sorted = [min, max].sort((a, b) => a - b);
    return `${sorted[0].toFixed(3)} → ${sorted[1].toFixed(3)}`;
  }

  function updateInfo(entry) {
    if (!entry) {
      tagEl.textContent = '—';
      scaleEl.textContent = '—';
      rangeInfoEl.textContent = '—';
      i2cInfoEl.textContent = '—';
      activeBadge.textContent = '—';
      activeBadge.classList.remove('active');
      rangeEl.disabled = true;
      inputEl.disabled = true;
      sendBtn.disabled = true;
      zeroBtn.disabled = true;
      fullScaleBtn.disabled = true;
      unitHintEl.textContent = 'Unité définie dans la configuration';
      return;
    }
    tagEl.textContent = entry.name;
    const gain = ExampleUtils.normaliseNumber(entry.scale);
    const offset = ExampleUtils.normaliseNumber(entry.offset) ?? 0;
    scaleEl.textContent = `${gain ?? '—'} / ${offset}`;
    rangeInfoEl.textContent = computeRangeText(entry.scale, entry.offset);
    i2cInfoEl.textContent = entry.i2cAddress || '0x60 (défaut)';
    rangeEl.disabled = false;
    inputEl.disabled = false;
    sendBtn.disabled = false;
    zeroBtn.disabled = false;
    fullScaleBtn.disabled = false;
    unitHintEl.textContent = 'Unité définie dans la configuration';
  }

  function applyActiveBadge(data) {
    if (!data) {
      activeBadge.textContent = '—';
      activeBadge.classList.remove('active');
      return;
    }
    if (data.active) {
      activeBadge.textContent = 'Sortie active';
      activeBadge.classList.add('active');
    } else {
      activeBadge.textContent = 'Sortie désactivée';
      activeBadge.classList.remove('active');
    }
  }

  function clamp(value, min, max) {
    if (!Number.isFinite(value)) return value;
    if (Number.isFinite(min) && value < min) return min;
    if (Number.isFinite(max) && value > max) return max;
    return value;
  }

  function updateControlsFromValue(value) {
    const num = ExampleUtils.normaliseNumber(value);
    if (num === null) {
      return;
    }
    const clamped = clamp(num, Number(rangeEl.min), Number(rangeEl.max));
    rangeEl.value = clamped;
    inputEl.value = num.toFixed(3);
  }

  function updateDisplay() {
    if (!state.selected) {
      currentValueEl.textContent = '—';
      rawCodeEl.textContent = '—';
      applyActiveBadge(null);
      return;
    }
    const entry = state.entries.find(e => e.name === state.selected);
    const measurement = state.values[state.selected];
    const current = measurement ? measurement.value : null;
    currentValueEl.textContent = ExampleUtils.formatNumber(current, 3);
    applyActiveBadge(measurement);
    if (entry) {
      const raw = ExampleUtils.applyOutputScale(current, entry.scale, entry.offset);
      rawCodeEl.textContent = raw === null ? '—' : raw.toFixed(0);
      if (!state.editing) {
        updateControlsFromValue(current);
      }
    } else {
      rawCodeEl.textContent = '—';
    }
  }

  async function refreshValues() {
    try {
      const map = await ExampleUtils.fetchOutputsValues();
      state.values = map;
      updateDisplay();
      showStatus('');
    } catch (err) {
      showStatus(err.message || 'Erreur de lecture', true);
    }
  }

  function handleSelectChange() {
    state.selected = selectEl.value || null;
    const entry = state.entries.find(e => e.name === state.selected);
    updateInfo(entry);
    updateDisplay();
  }

  async function sendValue(value) {
    if (!state.selected) {
      showStatus('Sélectionnez une sortie DAC.', true);
      return;
    }
    const num = ExampleUtils.normaliseNumber(value);
    if (num === null) {
      showStatus('Valeur invalide.', true);
      return;
    }
    try {
      showStatus('Envoi en cours…');
      await ExampleUtils.sendOutputValue(state.selected, num);
      showStatus('Consigne appliquée.');
      await refreshValues();
    } catch (err) {
      showStatus(err.message || 'Échec de l’envoi.', true);
    }
  }

  function handleSendClick() {
    sendValue(inputEl.value);
  }

  function handleZeroClick() {
    rangeEl.value = '0';
    inputEl.value = '0';
    sendValue(0);
  }

  function handleFullScaleClick() {
    const entry = state.entries.find(e => e.name === state.selected);
    if (!entry) {
      sendValue(0);
      return;
    }
    const gain = ExampleUtils.normaliseNumber(entry.scale);
    const offset = ExampleUtils.normaliseNumber(entry.offset) ?? 0;
    if (!Number.isFinite(gain) || gain === 0) {
      sendValue(0);
      return;
    }
    const target = (4095 - offset) / gain;
    rangeEl.value = clamp(target, Number(rangeEl.min), Number(rangeEl.max));
    inputEl.value = target.toFixed(3);
    sendValue(target);
  }

  function handleRangeInput() {
    markEditing();
    inputEl.value = parseFloat(rangeEl.value).toFixed(3);
  }

  function handleNumberInput() {
    markEditing();
    const num = ExampleUtils.normaliseNumber(inputEl.value);
    if (num !== null) {
      const clamped = clamp(num, Number(rangeEl.min), Number(rangeEl.max));
      rangeEl.value = clamped;
    }
  }

  async function init() {
    const cfg = await ExampleUtils.loadConfig();
    state.entries = ExampleUtils.outputsByType(cfg, 'mcp4725');
    selectEl.innerHTML = '';
    if (!state.entries.length) {
      const opt = document.createElement('option');
      opt.textContent = 'Aucune sortie DAC active';
      opt.value = '';
      selectEl.appendChild(opt);
      selectEl.disabled = true;
      showStatus('Activez une sortie DAC dans la configuration.', true);
      updateInfo(null);
      return;
    }
    state.entries.forEach(entry => {
      const opt = document.createElement('option');
      opt.value = entry.name;
      opt.textContent = entry.name;
      selectEl.appendChild(opt);
    });
    selectEl.disabled = false;
    state.selected = state.entries[0].name;
    selectEl.value = state.selected;
    updateInfo(state.entries[0]);
    await refreshValues();
    stopTimer();
    state.timer = setInterval(refreshValues, 1000);
  }

  selectEl.addEventListener('change', handleSelectChange);
  sendBtn.addEventListener('click', handleSendClick);
  zeroBtn.addEventListener('click', handleZeroClick);
  fullScaleBtn.addEventListener('click', handleFullScaleClick);
  rangeEl.addEventListener('input', handleRangeInput);
  inputEl.addEventListener('input', handleNumberInput);
  window.addEventListener('beforeunload', stopTimer);

  ensureSession()
    .then(init)
    .catch(err => {
      showStatus(err.message || 'Authentification requise', true);
    });
})();
</script>
</body>
</html>
