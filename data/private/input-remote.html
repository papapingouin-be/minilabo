<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <title>Exemple – Entrée distante</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 1em; max-width: 780px; }
    h1 { margin-top: 0; }
    .controls { display: flex; gap: 0.5em; align-items: center; flex-wrap: wrap; margin-bottom: 1em; }
    select { padding: 0.3em; }
    .panel { border: 1px solid #d0d7e2; border-radius: 8px; padding: 1em; background: #fdfefe; margin-bottom: 1em; }
    .panel h2 { margin-top: 0; font-size: 1.05em; }
    .metrics { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 0.75em; }
    .metric { background: #f3f7ff; border-radius: 6px; padding: 0.75em; }
    .metric span { display: block; font-size: 0.85em; color: #4b5874; }
    .metric strong { font-size: 1.3em; }
    code { background: #eef2f8; padding: 0.2em 0.4em; border-radius: 4px; }
    .hint { font-size: 0.95em; color: #34495e; }
    .status { color: #c0392b; font-size: 0.9em; }
  </style>
  <script src="../auth.js"></script>
  <script src="io-exemples-utils.js"></script>
</head>
<body>
<h1>Exemple – Entrée distante</h1>
<p class="hint">Une entrée de type <strong>remote</strong> applique une échelle à la valeur reçue d'un autre nœud MiniLabBox. Vérifiez ici que le nom de nœud et le nom distant correspondent et observez la valeur avant/après conversion.</p>

<div class="controls">
  <label for="inputSelect">Entrée distante&nbsp;:</label>
  <select id="inputSelect"></select>
  <span class="status" id="status"></span>
</div>

<div class="panel">
  <h2>Détails de l'entrée</h2>
  <p class="hint">Tag JSON&nbsp;: <code id="tagName">—</code></p>
  <p class="hint">Nœud distant&nbsp;: <span id="remoteNode">—</span> | Nom distant&nbsp;: <span id="remoteName">—</span></p>
  <p class="hint">Échelle appliquée&nbsp;: <span id="scaleInfo">—</span></p>
</div>

<div class="panel">
  <h2>Valeurs reçues</h2>
  <div class="metrics">
    <div class="metric">
      <span>Valeur convertie</span>
      <strong id="value">—</strong>
      <span id="unit">—</span>
    </div>
    <div class="metric">
      <span>Valeur reçue (avant échelle)</span>
      <strong id="rawValue">—</strong>
      <span>Directement depuis le nœud distant</span>
    </div>
  </div>
</div>

<p class="hint">Assurez-vous que le nœud distant diffuse bien la mesure via UDP et que les identifiants <em>remoteNode</em> et <em>remoteName</em> correspondent exactement à sa configuration.</p>

<script>
(function() {
  let state = {
    entries: [],
    selected: null,
    timer: null,
    values: {}
  };

  const selectEl = document.getElementById('inputSelect');
  const valueEl = document.getElementById('value');
  const unitEl = document.getElementById('unit');
  const rawEl = document.getElementById('rawValue');
  const tagEl = document.getElementById('tagName');
  const nodeEl = document.getElementById('remoteNode');
  const nameEl = document.getElementById('remoteName');
  const scaleEl = document.getElementById('scaleInfo');
  const statusEl = document.getElementById('status');

  function stopTimer() {
    if (state.timer) {
      clearInterval(state.timer);
      state.timer = null;
    }
  }

  function updateInfo(entry) {
    if (!entry) {
      tagEl.textContent = '—';
      nodeEl.textContent = '—';
      nameEl.textContent = '—';
      unitEl.textContent = '—';
      scaleEl.textContent = '—';
      return;
    }
    tagEl.textContent = entry.name;
    nodeEl.textContent = entry.remoteNode || '—';
    nameEl.textContent = entry.remoteName || '—';
    unitEl.textContent = entry.unit || '—';
    const gain = ExampleUtils.normaliseNumber(entry.scale);
    const offset = ExampleUtils.normaliseNumber(entry.offset) ?? 0;
    scaleEl.textContent = `${gain ?? '—'} / ${offset}`;
  }

  function updateDisplay() {
    if (!state.selected) {
      valueEl.textContent = '—';
      rawEl.textContent = '—';
      return;
    }
    const entry = state.entries.find(e => e.name === state.selected);
    if (!entry) return;
    const current = state.values[state.selected];
    valueEl.textContent = ExampleUtils.formatNumber(current);
    const remoteVal = ExampleUtils.computeRawValue(current, entry.scale, entry.offset);
    rawEl.textContent = remoteVal === null ? '—' : ExampleUtils.formatNumber(remoteVal);
  }

  async function refreshValues() {
    try {
      const map = await ExampleUtils.fetchInputsValues();
      state.values = map;
      updateDisplay();
      statusEl.textContent = '';
    } catch (err) {
      statusEl.textContent = err.message || 'Erreur de lecture';
    }
  }

  function handleSelectChange() {
    state.selected = selectEl.value || null;
    const entry = state.entries.find(e => e.name === state.selected);
    updateInfo(entry);
    updateDisplay();
  }

  async function init() {
    const cfg = await ExampleUtils.loadConfig();
    state.entries = ExampleUtils.inputsByType(cfg, 'remote');
    selectEl.innerHTML = '';
    if (!state.entries.length) {
      const opt = document.createElement('option');
      opt.textContent = 'Aucune entrée distante active';
      opt.value = '';
      selectEl.appendChild(opt);
      selectEl.disabled = true;
      statusEl.textContent = 'Ajoutez une entrée remote pour voir les valeurs reçues.';
      return;
    }
    state.entries.forEach(entry => {
      const opt = document.createElement('option');
      opt.value = entry.name;
      const labelParts = [entry.name];
      if (entry.remoteNode) labelParts.push(`← ${entry.remoteNode}`);
      opt.textContent = labelParts.join(' ');
      selectEl.appendChild(opt);
    });
    selectEl.disabled = false;
    state.selected = state.entries[0].name;
    selectEl.value = state.selected;
    updateInfo(state.entries[0]);
    await refreshValues();
    stopTimer();
    state.timer = setInterval(refreshValues, 1000);
  }

  selectEl.addEventListener('change', handleSelectChange);
  window.addEventListener('beforeunload', stopTimer);

  ensureSession()
    .then(init)
    .catch(err => {
      statusEl.textContent = err.message || 'Authentification requise';
    });
})();
</script>
</body>
</html>
